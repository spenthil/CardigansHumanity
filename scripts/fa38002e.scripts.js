"use strict";angular.module("CardigansHumanityApp",["cardcard"]).factory("$exceptionHandler",["$window","$log",function(a,b){return b.debug("Using the default logging exception handler."),function(){b.error.apply(b,arguments)}}]),angular.module("cardcard",[]),angular.module("cardcard").service("cardcard",["$log","$q","$sce",function(a,b,c){function d(a){var b=/^#?([a-f\d])([a-f\d])([a-f\d])$/i;a=a.replace(b,function(a,b,c,d){return b+b+c+c+d+d});var c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);return c?[parseInt(c[1],16),parseInt(c[2],16),parseInt(c[3],16)]:null}this.options={cards:["Cardigans are the _____.","worst creation imagined","most horrible thing"].join("\n"),pagePadding:[.2,.4],cardSpacing:[.1,.1],cardWidth:2.5,cardHeight:3.5,fontSize:14,lineHeight:1.4,whiteCardsFontColor:"#000000",blackCardsFontColor:"#000000",whiteCardsFontStroke:"none",blackCardsFontStroke:"none",blackBorderColor:"#000000",whiteBorderColor:"#000000",whiteLogoCardsFontColor:"#000000",blackLogoCardsFontColor:"#000000",cardPadding:[.1,.15],cardRadius:0,fontWeight:"Bold",fontFamily:"Helvetica",blank:"_____",logoWidth:.2,logoFontSize:10,logoFontWeight:"Bold",logoFontFamily:"Helvetica",whiteLogoCardsStroke:"#000000",blackLogoCardsStroke:"#000000",whiteLogoCardsFontStroke:"none",blackLogoCardsFontStroke:"none",logoText:"Cardigans Humanity",fileName:"CardigansHumanity.svg",strokeWidth:".01",strokeWidthLogo:".01"};var e=function(a){return a*(Math.PI/180)},f=function(a){return Math.cos(e(a))},g=function(a){return Math.sin(e(a))},h=function(){this._pdf=new jsPDF("portrait","in","letter")};h.prototype={addPage:function(){this._pdf.addPage()},_setFill:function(a){var b="";if("none"!==a){doc.setDrawColor(0);var c=d(a);this._pdf.setFillColor(c[0],c[1],c[2]),b+="F"}return b},_setStroke:function(a,b){var c="";if("none"!==a){var e=d(a);this._pdf.setFillColor(e[0],e[1],e[2]),this._pdf.setLineWidth(b),c+="D"}return c},drawRectangle:function(a,b,c,d,e,f,g,h){var i="";i+=this._setFill(h),i+=this._setStroke(g,f),this._pdf.roundedRect(a,b,c,d,e,e,i)},drawText:function(a,b,c,e,f,g,h,i,j){this._pdf.lineHeightProportion=j;var k=d(i);this._pdf.setTextColor(k[0],k[1],k[2]).setFont(f,g).setFontSize(h);var l;l="undefined"!=typeof e?this._pdf.splitTextToSize(a,e):a;var m=h/72;return this._pdf.text(b,c+m,l),l},drawLines:function(a,b,c){this._setStroke(c,b),this._pdf.lines(a.slice(1),a[0][0],a[0][1])},openNewWindow:function(){return this._pdf.output("dataurlnewwindow")},uriString:function(){return this._pdf.output("datauristring")}};var i=function(c,d,e){d="undefined"!=typeof d?d:"\n",e="undefined"!=typeof e?e:h;var i=b.defer(),j=c.cards.split(d),k=new e,l=0,m=-1,n=3,o=3,p="";return j.every(function(b,d){var e=!1;if(b=b.trim(),""===b)return!0;var h=-1!==b.indexOf(c.blank);m+1===n?(l+=1,l===o&&(l=0,console.debug(JSON.stringify("Adding PDF page.",null,2)),k.addPage()),m=0):m+=1;var i=c.pagePadding[1]+m*(c.cardWidth+c.cardSpacing[1]),j=c.pagePadding[0]+l*(c.cardHeight+c.cardSpacing[0]);k.drawRectangle(i,j,c.cardWidth,c.cardHeight,c.cardRadius,c.strokeWidth,h?c.blackBorderColor:c.whiteBorderColor,"none");var q=i+c.cardPadding[1],r=j+c.cardPadding[0],s=r,t=b.split(c.blank),u=h?c.blackCardsFontColor:c.whiteCardsFontColor,v=c.cardWidth-2*c.cardPadding[1],w=c.fontSize/72*c.lineHeight;if(t.forEach(function(a,b){var d=a.split(" "),e=!1;if(~[".","?",","].indexOf(d[0])&&(e=d[0],a=a.substring(2)),0!==b&&b!==(b!==t.length-1)){var f,g=q,h=s+.8*w;if(e){var i=c.fontSize/72;f=v-i,k.drawText(e,g+v-i,s,v,c.fontFamily,c.fontWeight,c.fontSize,u,c.lineHeight)}else f=v;k.drawLines([[g,h],[f,0]],c.strokeWidth,u),s+=w}if(a=a.trim(),a&&("."!==a&&""!==a||b!==t.length-1)){var j=k.drawText(a,q,s,v,c.fontFamily,c.fontWeight,c.fontSize,u,c.lineHeight);s+=w*j.length}}),c.logoText){var x=i+c.cardPadding[1]+.75*c.logoWidth,y=j+c.cardHeight-2*c.logoWidth,z=function(a,b){z.angle+=a,z.points.push([f(z.angle)*b*c.logoWidth,g(z.angle)*b*c.logoWidth])};z.angle=0,z.points=[[x,y]];var A=60;z(0,.35),z(A,.9),z(90,.2),z(90,.7),z(150+A,.8),z(90,.6),z(90,.8),z(150+A,.7),z(90,.2),z(90,.9),z(A,.35),z(90,1.1),k.drawLines(z.points,c.strokeWidthLogo,h?c.blackLogoCardsStroke:c.whiteLogoCardsStroke),k.drawText(c.logoText,x+c.logoWidth,y,v,c.logoFontFamily,c.logoFontWeight,c.logoFontSize,h?c.blackLogoCardsFontColor:c.whiteLogoCardsFontColor,c.lineHeight)}return e===!0?(a.debug("failed to create card: "+p),!1):(p="",!0)}),p?i.reject(p):i.resolve(k),i.promise};this.createUriString=function(a){return i(a).then(function(a){return c.trustAsResourceUrl(a.uriString())})},this.createNewWindow=function(a){return i(a).then(function(a){a.openNewWindow()})}}]),angular.module("CardigansHumanityApp").controller("MainCtrl",["$scope","$log","$q","cardcard",function(a,b,c,d){a.previewUriString="",a.error="",a.options=d.options,a.previewCards=function(){d.createUriString(a.options).then(function(b){a.previewUriString=b,a.error=""},function(b){a.previewUriString="",a.error=b})},a.downloadCards=function(){d.createNewWindow(a.options).then(function(){},function(b){a.previewUriString="",a.error=b})},a.previewCards()}]);